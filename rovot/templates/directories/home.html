{% extends 'directories/base.html' %}
{% load static %}
{% block content %}
    <div class="home-container">
        <div class="logout-button">
            <a href="{% url 'rovot-logout' %}">logout</a>
        </div>
        <div class="chatbox-form">
            <div class="chatbox">
                <div class="chatbox-messages">
                    <div class="chatbox-header">
                        <p>Hi {{request.user}}, my name is Rovot. I am trained to give a list of movie suggestion based on what your are feeling right now.</p>
                        <p><br>To get started, I'll need to ask how are you today?</p>
                    </div>
                    <div class="messages-container">
                        <div class="msg">

                        </div>
                    </div>
                </div>
            </div>
            <div class="chatbox-input">
                <div class="chatbox-result">
                    <a href="{% url 'rovot-result'%}" class="result-button">
                        <p>Or, would you like to see the movies?</p>
                    </a>
                </div>
                <div class="input-group">
                    <input type="text" class="input-chat" name="msg-chat" placeholder="chat with Mr. Rovot...">
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <script>
        var chatterbotUrl = '{% url "chatterbot" %}';
        var csrftoken = Cookies.get('csrftoken');
  
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
  
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
  
        var $chatlog = $('.msg');
        var $input = $('.input-chat');

        var messageBody = document.querySelector('.chatbox');

        function createRow(text, side) {
            var $row = $('<div class="sent msg-text ' + side + '"></div>');

            $row.text(text);
            $chatlog.append($row);
        }

        function submitInput() {
            var inputData = {
                'text': $input.val()
            }
  
            // Display the user's input on the web page
            createRow(inputData.text, 'right');
            
            jsondata = JSON.stringify(inputData)
            var $submit = $.ajax({
                type: 'POST',
                url: chatterbotUrl,
                data: jsondata,
                contentType: 'application/json'
            });
  
            $submit.done(function(statement) {
                // Creates a row for the chatbot's response
                createRow(statement.text, 'left')

                // Keep the container's current 'SCENE' at bottom
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                
            });
        }
  
        $input.keydown(function(event) {
            // Submit the input when the enter button is pressed
            if (event.keyCode == 13) {
                submitInput();
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                $input.val('');
            }
        });
    </script>
{% endblock %}